name: Pull Request CI

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled, unlabeled]
  merge_group:

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: PR Details
        run: |
          echo "### Pull Request CI Pipeline :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Running comprehensive test suite..." >> $GITHUB_STEP_SUMMARY

  require-label:
    name: Require Label
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    
    steps:
      - uses: mheap/github-action-required-labels@v5.5.0
        with:
          mode: minimum
          count: 1
          labels: |
            bug
            chore
            configuration
            dependencies
            documentation
            enhancement
            maintenance
          add_comment: true

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          pip install tox tox-gh-actions

      - name: Run tests with tox
        run: |
          tox -e py$(echo ${{ matrix.python-version }} | tr -d .)

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-python-${{ matrix.python-version }}
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          pip install tox

      - name: Run linting with tox
        run: |
          tox -e lint

  format:
    name: Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          pip install tox

      - name: Run formatter check with tox
        run: |
          tox -e format

  all-tests-passed:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [require-label, test, lint, format]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "### Test Results Summary :test_tube:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.require-label.result }}" == "success" ] || [ "${{ needs.require-label.result }}" == "skipped" ]; then
            echo "✅ Label Requirement: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Label Requirement: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ Tests (Python 3.10-3.14): Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Tests (Python 3.10-3.14): Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "✅ Lint: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Lint: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.format.result }}" == "success" ]; then
            echo "✅ Format: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Format: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Fail if any required job failed
          if [ "${{ needs.require-label.result }}" == "failure" ] || \
             [ "${{ needs.test.result }}" == "failure" ] || \
             [ "${{ needs.lint.result }}" == "failure" ] || \
             [ "${{ needs.format.result }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ Some tests failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All tests passed! PR is ready for review." >> $GITHUB_STEP_SUMMARY
